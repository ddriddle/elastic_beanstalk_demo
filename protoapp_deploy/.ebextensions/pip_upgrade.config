# vim: set filetype=yaml tabstop=2 shiftwidth=2:

files:
  "/opt/elasticbeanstalk/hooks/appdeploy/pre/02_pip.py":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/usr/bin/env python

      from __future__ import print_function

      import os
      import sys

      from subprocess import check_call

      sys.path.append(os.path.dirname(
          os.path.dirname(os.path.dirname(os.path.abspath(__file__)))))

      import config

      def upgrade_pip():
          APP_STAGING_DIR = config.get_container_config('app_staging_dir')
          APP_VIRTUAL_ENV = config.get_container_config('app_virtual_env')

          check_call('%s install --upgrade pip' % \
            (os.path.join(APP_VIRTUAL_ENV, 'bin', 'pip')), shell=True)

      def main():
          try:
              upgrade_pip()

          except Exception, e:
              config.emit_error_event(config.USER_ERROR_MESSAGES['deployfail'])
              config.diagnostic("Could not update pip: %s" % str(e))
              sys.exit(1)

      if __name__ == '__main__':
          config.configure_stdout_logger()
          main()
